\begin{figure*}[!t]
\raggedright
%
\textbf{Syntax}\\
%
\begin{smathpar}
\renewcommand{\arraystretch}{1.2}
\begin{array}{lclcl}
\multicolumn{5}{c} {
  {x,y} \in \mathtt{Variables}\;\;\spc
  {f} \in \mathtt{Field\;Names} \;\;\spc
% {\tau} \in \mathtt{Table\;Names}
  {i,j} \in \mathbb{N} \;\;\spc
  {\odot} \in \{+,-,\le,\ge,=\}\;\;\spc
  {k} \in \mathbb{Z}\cup\mathbb{B} \;\;\spc
  {\rec} \in \langle \bar{f}=\bar{k}\rangle
}\\
{\stl,\stg,s} & \in & \mathtt{State} & \coloneqq &  \Pow{\langle
  \bar{f}=\bar{k} \rangle} \\
{\I_e, \I_c }  & \in & \mathtt{Isolation Spec} & \coloneqq & (\stl,\stg,\stg') \rightarrow \Prop\\
v & \in & \mathtt{Values} & \coloneqq & k \ALT \rec \ALT s\\
e & \in & \mathtt{Expressions} & \coloneqq & v \ALT x \ALT x.f 
    \ALT \langle \bar{f}=\bar{e} \rangle \ALT e_1 \odot e_2\\ 
c & \in & \mathtt{Commands} & \coloneqq & \lete{x}{e}{c}
    \ALT \ite{e}{c_1}{c_2}\ALT c_1;c_2 \ALT \inserte{x}  \\
&&&&\ALT \deletee{\lambda x.e}
    \ALT \lete{y}{\selecte{\lambda x.e}}{c}
    \ALT \updatee{\lambda x.e_1}{\lambda x.e_2}\\
&&&&\ALT \foreache{x}{\lambda y.\lambda z. c} 
    \ALT \foreachr{s_1}{s_2}{\lambda x.\lambda y. e}\\
&&&&\ALT \ctxn{i}{\I}{ c } \ALT \ctxnr{i}{\I,\stl,\stg}{c} \ALT c_1 ||
  c_2 \ALT \cskip \\
% t & \in & \mathtt{Terms} & \coloneqq & e \ALT c\\
\ectx & \in & \mathtt{Eval\;Ctx} & ::= & \bullet \ALT  
  \bullet || c_2 \ALT c_1 || \bullet \ALT \bullet;\,c_2 
  \ALT \ctxnr{i}{\I,\stl,\stg}{\bullet} \\
\end{array}
\end{smathpar}
%
\bigskip

\renewcommand{\arraystretch}{1.2}

%
\textbf{Local Reduction} \quad 
\fbox {\(\stg \vdash (\tbox{c}_i,\stl) \stepsto (\tbox{c'}_i,\stl')\)}\\
%
\bigskip

%
\begin{minipage}{2.45in}
\rulelabel{E-Insert}
\begin{smathpar}
\begin{array}{c}
\RULE
{
  r.\idf \not\in \dom(\stl \cup \stg)\\
  r' = \langle r \;\C{with}\; \txnf=i;\,\delf=\C{false} \rangle
}
{
  \stg \vdash (\tbox{\inserte{r}}_i,\stl) \stepsto
  (\tbox{\cskip}_i,\stl \cup \{r'\})
}
\end{array}
\end{smathpar}
\end{minipage}
%
%
\begin{minipage}{2.6in}
\rulelabel{E-Select}
\begin{smathpar}
\begin{array}{c}
\RULE
{
  \\
  s = \{r\in\Delta \,|\, \eval([r/x]e)=\C{true}\}\spc
  c' = [s/y]c
}
{
  \stg \vdash (\tbox{\lete{y}{\selecte{\lambda x.e}}{c}}_i, \stl) \stepsto 
              (\tbox{c'}_i,\stl)
}
\end{array}
\end{smathpar}
\end{minipage}
%
\bigskip

%
\begin{minipage}{2.5in}
\rulelabel{E-Delete}
\begin{smathpar}
\begin{array}{c}
\RULE
{
  \dom(\stl)\cap\dom(s) = \emptyset \\
  \hspace*{-0.4in}
  s = \{r' \,|\, \exists(r\in\Delta).~ \eval([r/x]e)=\C{true} \\
      \hspace*{0.2in}\conj r'=\langle r \with \delf=\C{true};\,
      \txnf=i \rangle\}\\
% \dom(s) \cap \dom(\delta) = \emptyset
}
{
  \stg \vdash (\tbox{\deletee{\lambda x.e}}_i,\stl) \stepsto 
  (\tbox{\cskip}_i,\stl \cup s)
}
\end{array}
\end{smathpar}
\end{minipage}
%
%
\begin{minipage}{2.8in}
\rulelabel{E-Update}
\begin{smathpar}
\begin{array}{c}
\RULE
{
  \dom(\stl) \cap \dom(s) = \emptyset\\
  \hspace*{-0.8in}s = \{r' \,|\, \exists(r\in\Delta).~ 
    \eval([r/x]e_2)=\C{true} \conj \\
  r'= \langle [r/x]e_1 \;\C{with}\;
    \idf=r.\idf;\,\txnf=i;\,\delf = r.\delf \rangle \}
}
{
  \stg \vdash (\tbox{\updatee{\lambda x.e_1}{\lambda x.e_2}}_i,\stl) 
      \stepsto (\tbox{\cskip}_i,\stl \cup s)
}
\end{array}
\end{smathpar}
\end{minipage}
%
\bigskip

\begin{smathpar}
\begin{array}{ll}
  \rulelabel{E-Foreach1} & \stg \vdash (\tbox{\foreache{s}{\lambda y.\lambda
    z.c}}_i,\stl) \stepsto (\tbox{\foreachr{\emptyset}{s}{\lambda
    y.\lambda z. c}}_i,\stl)\\
  \rulelabel{E-Foreach2} & \stg \vdash (\tbox{\foreachr{s_1}{\{r\} \uplus s_2}
    {\lambda y.\lambda z.c}}_i,\stl) \stepsto (\tbox{[r/z][s_1/y]c;\,\\
    & \hspace*{2.5in}\foreachr{s_1 \cup \{r\}}{s_2}{\lambda y.\lambda z. c}}_i,\stl)\\
  \rulelabel{E-Foreach3} & \stg \vdash (\tbox{\foreachr{s}{\emptyset}
    {\lambda y.\lambda z.c}}_i,\stl) \stepsto (\tbox{\cskip}_i,\stl)\\
\end{array}
\end{smathpar}
%
\bigskip

%
\textbf{Top-Level Reduction} \quad 
\fbox {\((c,\stg) \stepsto (c',\stg')\)}\\
%
\bigskip

\begin{minipage}{2.5in}
  \rulelabel{E-Txn-Start}
  \begin{smathpar}
  \begin{array}{c}
    \RULE{\\}
         {(\ctxn{i}{\I}{c},\stg) \stepsto (\ctxnr{i}{\I,\emptyset,\stg}{c},\stg)}
  \end{array}
  \end{smathpar}
\end{minipage}%
\begin{minipage}{2.3in}
\rulelabel{E-Txn}
\begin{smathpar}
\begin{array}{c}
\RULE
{
  \I_e\,\,(\stl,\stg,\stg')\spc
  \stg \vdash (\tbox{c}_i,\stl) \stepsto (\tbox{c'}_i,\stl')
}
{
  (\ctxnr{i}{\I,\stl,\stg}{c},\stg') \stepsto
  (\ctxnr{i}{\I,\stl',\stg'}{c'},\stg')
}
\end{array}
\end{smathpar}
\end{minipage}\\
%
\bigskip

\begin{center}
\begin{minipage}{3in}
\rulelabel{E-Commit}
\begin{smathpar}
\begin{array}{c}
\RULE
{
  \I_c\,\,(\stl,\stg,\stg')
}
{
  (\ctxnr{i}{\I,\stl,\stg}{\cskip},\stg') \stepsto (\cskip,\stl \rhd \stg')
}
\end{array}
\end{smathpar}
\end{minipage}
\end{center}
\hfill
%
\caption{\small \txnimp: Syntax and Small-step semantics}
\label{fig:txnimp}
\end{figure*}

